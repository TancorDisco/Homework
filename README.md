# API для управления пользователями с регистрацией, логином, логаутом и сбросом пароля

## Описание проекта

### Основные особенности:
- **Роли и права доступа:** `USER` и `ADMIN`, где `USER` может только читать данные, а `ADMIN` имеет доступ к CRUD-операциям.
- **Безопасность:** токены с ограниченным сроком действия, автоматическая поддержка сессий, контроль логаута через Redis.
- **Структура ролей**: отделена в базе данных, что упрощает поддержку и расширение в будущем.

## Стек технологий (кроме Spring)
- **JWT-токены** — для безопасного хранения информации о сессии.
- **Redis** — для управления сессиями и логаутом.
- **PostgreSQL** — для хранения данных о пользователях и ролях.

## Реализованные возможности

### 1. Регистрация пользователей

Регистрация реализована с учётом надёжного хранения паролей и защиты данных пользователей.
- **Хеширование паролей** — выполняется с помощью `BCrypt`, что усложняет взлом паролей.
- **Назначение ролей** — у нового пользователя роль `USER` по умолчанию.
- **Отдельная таблица ролей**: роли (`Role`) вынесены в отдельную таблицу, что позволяет:
   - Легче управлять привилегиями и добавлять новые роли.
   - Улучшить нормализацию базы данных и уменьшить дублирование данных.

### 2. Аутентификация (логин) и выдача токенов

#### Токен и сессии

Для аутентификации используется `JWT`-токен, генерируемый при логине.
- **Срок действия токена** — токен действителен 10 минут по умолчанию. При опции "Запомнить меня" (`remember-me`) срок действия увеличивается до 30 дней.
- **Spring Security фильтр** — для обработки токена используется фильтр, который проверяет каждый запрос. Фильтр:
   - Сначала извлекает токен из заголовка запроса.
   - Проверяет его валидность, а затем проверяет срок действия.
   - При валидности токена устанавливает текущего пользователя для SecurityContext, что позволяет обеспечить дальнейшую авторизацию.

#### Кастомный `UserDetailsService`

Создан собственный класс `CustomUserDetailsService`, реализующий интерфейс `UserDetailsService`.
- Этот сервис:
   - Находит пользователя в базе по логину.
   - Загружает его данные (включая роли) для аутентификации.
- **Преимущество кастомного подхода**: позволяет использовать специфические данные о пользователе, добавлять методы и логику, специфичную для приложения.

### 3. Логаут с использованием Redis

#### Управление токенами и Redis

Redis используется для хранения состояния токенов и управлением их завершения срока действия. (Поднимался в Docker)
- **Логаут** — при логауте токен пользователя записывается в Redis с меткой "недействителен", что позволяет:
   - Отслеживать, какие токены были принудительно аннулированы.
   - Обеспечить отзыв доступа пользователя сразу после логаута, что защищает от несанкционированного использования старых токенов.

### 4. Ограничение доступа на основе ролей

Доступ к эндпоинтам зависит от роли пользователя.
- **Настройка доступа**:
   - Пользователь с ролью `USER` может только читать данные.
   - Пользователь с ролью `ADMIN` имеет доступ к CRUD-операциям.
- **Настройки в Spring Security**:
   - Используется аннотация `@PreAuthorize` для ограничения доступа на уровне контроллеров.
   - Определены правила безопасности в конфигурационном классе SecurityConfig для защиты эндпоинтов и маршрутов.

### 5. Сброс пароля и 2FA-подтверждение

Реализован процесс сброса пароля через эндпоинт API.
- **Подтверждение через 2FA**: использована заглушка с кодом `0000`.
- **Процесс сброса пароля**:
   - Пользователь запрашивает сброс пароля, а затем вводит код и новый пароль.
   - Реализована проверка безопасности на каждом этапе, чтобы предотвратить несанкционированный доступ.

### Пример работы с токенами и ролями в базе данных

#### Таблица `roles`

| Поле      | Тип данных | Описание                     |
|-----------|------------|------------------------------|
| role_id   | SERIAL     | Идентификатор роли           |
| role_name | VARCHAR    | Имя роли (например, `USER`)  |

#### Таблица `users`

| Поле      | Тип данных | Описание                     |
|-----------|------------|------------------------------|
| user_id   | SERIAL     | Идентификатор пользователя   |
| username  | VARCHAR    | Логин пользователя           |
| password  | VARCHAR    | Хэш пароля                   |
| salt      | VARCHAR    | Соль для шифрования пароля   |

#### Таблица `user_roles`

Эта таблица связывает пользователей с ролями (ManyToMany), что позволяет одному пользователю иметь несколько ролей.

| Поле      | Тип данных | Описание                     |
|-----------|------------|------------------------------|
| user_id   | INT        | Идентификатор пользователя   |
| role_id   | INT        | Идентификатор роли           |

### Основные эндпоинты

| Метод | URL                        | Описание                                  |
|-------|----------------------------|-------------------------------------------|
| POST  | `/api/auth/register`       | Регистрация пользователя                  |
| POST  | `/api/auth/login`          | Логин пользователя, получение токена      |
| POST  | `/api/auth/logout`         | Логаут пользователя, аннулирование токена |
| POST  | `/api/auth/req-pass-reset` | Запрос на сброс пароля                    |
| POST  | `/api/auth/reset-pass`     | Сброс пароля с подтверждением через 2FA   |
